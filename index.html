<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>工時月曆</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 16px;
}

h1 {
  text-align: center;
}

.controls {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.controls select,
.controls input,
.controls button {
  flex: 1;
  padding: 8px;
  font-size: 16px;
}

.summary {
  background: white;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 12px;
}

.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
}

.week {
  text-align: center;
  font-weight: bold;
}

.day {
  background: white;
  border-radius: 6px;
  padding: 6px;
  min-height: 70px;
  display: flex;
  flex-direction: column;
  font-size: 14px;
}

.day header {
  font-weight: bold;
}

.day input {
  margin-top: auto;
  width: 100%;
  font-size: 14px;
}
</style>
</head>

<body>

<h1>工時月曆</h1>

<div class="controls">
  <select id="ymSelect"></select>
  <button onclick="exportReadonly()">匯出唯讀</button>
</div>

<div class="summary">
  時薪：
  <input id="hourly" type="number" step="0.01" value="190">
  <p>總時數：<span id="totalHours">0.00</span> 小時</p>
  <p>薪水：$<span id="salary">0</span></p>
</div>

<div class="calendar" id="calendar"></div>

<script>
const ymSelect = document.getElementById("ymSelect");
const calendar = document.getElementById("calendar");
const totalHoursEl = document.getElementById("totalHours");
const salaryEl = document.getElementById("salary");
const hourlyInput = document.getElementById("hourly");

const now = new Date();
const currentYear = now.getFullYear();
const currentMonth = now.getMonth();

// 建立 年-月 選單（前後各 2 年）
for (let y = currentYear - 2; y <= currentYear + 2; y++) {
  for (let m = 0; m < 12; m++) {
    const opt = document.createElement("option");
    opt.value = `${y}-${m}`;
    opt.textContent = `${y} 年 ${m + 1} 月`;
    if (y === currentYear && m === currentMonth) opt.selected = true;
    ymSelect.appendChild(opt);
  }
}

function storageKey() {
  return `work-${ymSelect.value}`;
}

function loadMonth() {
  calendar.innerHTML = "";

  const [year, month] = ymSelect.value.split("-").map(Number);
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const data = JSON.parse(localStorage.getItem(storageKey())) || {};

  const weekNames = ["日","一","二","三","四","五","六"];
  weekNames.forEach(w => {
    const d = document.createElement("div");
    d.className = "week";
    d.textContent = w;
    calendar.appendChild(d);
  });

  for (let i = 0; i < firstDay; i++) {
    calendar.appendChild(document.createElement("div"));
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const cell = document.createElement("div");
    cell.className = "day";

    const header = document.createElement("header");
    header.textContent = day;
    cell.appendChild(header);

    const input = document.createElement("input");
    input.type = "number";
    input.step = "0.01";
    input.value = data[day] || "";

    input.addEventListener("input", () => {
      data[day] = input.value;
      localStorage.setItem(storageKey(), JSON.stringify(data));
      calculate();
    });

    cell.appendChild(input);
    calendar.appendChild(cell);
  }

  calculate();
}

function calculate() {
  const data = JSON.parse(localStorage.getItem(storageKey())) || {};
  let total = 0;

  Object.values(data).forEach(v => {
    total += parseFloat(v) || 0;
  });

  totalHoursEl.textContent = total.toFixed(2);
  salaryEl.textContent = (total * (parseFloat(hourlyInput.value) || 0)).toFixed(0);
}

function exportReadonly() {
  const data = localStorage.getItem(storageKey()) || "{}";
  const html = `
<!DOCTYPE html>
<html lang="zh-TW">
<meta charset="UTF-8">
<title>工時唯讀</title>
<h2>${ymSelect.options[ymSelect.selectedIndex].text}</h2>
<pre>${JSON.stringify(JSON.parse(data), null, 2)}</pre>
<p>總時數：${totalHoursEl.textContent}</p>
<p>薪水：$${salaryEl.textContent}</p>
`;
  const blob = new Blob([html], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "work_readonly.html";
  a.click();
}

ymSelect.addEventListener("change", loadMonth);
hourlyInput.addEventListener("input", calculate);

loadMonth();
</script>

</body>
</html>
