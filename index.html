<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>工時月曆</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 16px;
}

h1 {
  text-align: center;
}

.controls {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.controls select,
.controls input,
.controls button {
  flex: 1;
  padding: 10px;
  font-size: 16px;
}

.summary {
  background: white;
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 12px;
}

.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
}

.week {
  text-align: center;
  font-weight: bold;
}

.day {
  background: white;
  border-radius: 8px;
  padding: 6px;
  min-height: 70px;
  display: flex;
  flex-direction: column;
}

.day header {
  font-weight: bold;
}

.day input {
  margin-top: auto;
  width: 100%;
  box-sizing: border-box;
  font-size: 14px;
  padding: 4px;
}
</style>
</head>

<body>

<h1>工時月曆</h1>

<div class="controls">
  <select id="yearMonthSelect"></select>
  <button onclick="exportImage()">匯出成圖片</button>
</div>

<div class="summary" id="captureArea">
  時薪：
  <input id="hourly" type="number" step="0.01" value="190">
  <p>總時數：<span id="totalHours">0.00</span> 小時</p>
  <p>薪水：$<span id="salary">0</span></p>
</div>

<div class="calendar" id="calendar"></div>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const yearMonthSelect = document.getElementById("yearMonthSelect");
const calendar = document.getElementById("calendar");
const totalHoursEl = document.getElementById("totalHours");
const salaryEl = document.getElementById("salary");
const hourlyInput = document.getElementById("hourly");

const now = new Date();
const baseYear = now.getFullYear();
const baseMonth = now.getMonth();

// 建立年月選單（前後各 12 個月）
for (let i = -12; i <= 12; i++) {
  const d = new Date(baseYear, baseMonth + i, 1);
  const opt = document.createElement("option");
  opt.value = `${d.getFullYear()}-${d.getMonth()}`;
  opt.textContent = `${d.getFullYear()} 年 ${d.getMonth() + 1} 月`;
  if (i === 0) opt.selected = true;
  yearMonthSelect.appendChild(opt);
}

function getYearMonth() {
  const [y, m] = yearMonthSelect.value.split("-");
  return { year: +y, month: +m };
}

function storageKey() {
  const { year, month } = getYearMonth();
  return `work-${year}-${month}`;
}

function loadMonth() {
  calendar.innerHTML = "";

  const { year, month } = getYearMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const days = new Date(year, month + 1, 0).getDate();
  const data = JSON.parse(localStorage.getItem(storageKey())) || {};

  ["日","一","二","三","四","五","六"].forEach(w => {
    const d = document.createElement("div");
    d.className = "week";
    d.textContent = w;
    calendar.appendChild(d);
  });

  for (let i = 0; i < firstDay; i++) {
    calendar.appendChild(document.createElement("div"));
  }

  for (let day = 1; day <= days; day++) {
    const cell = document.createElement("div");
    cell.className = "day";

    const h = document.createElement("header");
    h.textContent = day;
    cell.appendChild(h);

    const input = document.createElement("input");
    input.type = "number";
    input.step = "0.01";
    input.value = data[day] || "";

    input.addEventListener("input", () => {
      data[day] = input.value;
      localStorage.setItem(storageKey(), JSON.stringify(data));
      calculate();
    });

    cell.appendChild(input);
    calendar.appendChild(cell);
  }

  calculate();
}

function calculate() {
  const data = JSON.parse(localStorage.getItem(storageKey())) || {};
  let total = 0;

  Object.values(data).forEach(v => {
    total += parseFloat(v) || 0;
  });

  totalHoursEl.textContent = total.toFixed(2);
  salaryEl.textContent = Math.round(total * (parseFloat(hourlyInput.value) || 0));
}

function exportImage() {
  html2canvas(document.body).then(canvas => {
    const img = canvas.toDataURL("image/png");
    const w = window.open("");
    w.document.write(`<img src="${img}" style="width:100%">`);
  });
}

yearMonthSelect.addEventListener("change", loadMonth);
hourlyInput.addEventListener("input", calculate);

loadMonth();
</script>

</body>
</html>
